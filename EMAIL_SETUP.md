# メール送信の設定ガイド

このドキュメントでは、Resendを使ったメール送信機能の設定方法を説明します。

## 📋 現在の状況

✅ **既に実装されているもの**
- メール送信のコード（`src/lib/email.ts`）
- 予約確認メールのテンプレート（HTML & テキスト）
- 予約APIでのメール送信処理

❌ **設定が必要なもの**
- Resendアカウント
- APIキーの設定
- 送信元メールアドレスの設定

---

## ステップ1: Resendアカウントの作成

### 1. Resendアカウントにサインアップ

1. [Resend](https://resend.com)にアクセス
2. "Sign Up" をクリック
3. メールアドレスでアカウントを作成

### 2. ダッシュボードにログイン

作成したアカウントでログインします。

---

## ステップ2: APIキーの取得

### 1. APIキーを作成

1. Resendダッシュボード → "API Keys"
2. "Create API Key" をクリック
3. 名前を入力（例: `rentacycle-production`）
4. 権限を選択：
   - **Full Access**（開発中はこれで問題ありません）
5. "Add" をクリック
6. **APIキーをコピー**（この画面を閉じると再表示できません！）

⚠️ **重要**: APIキーは安全な場所に保存してください。

---

## ステップ3: ドメインの設定（本番環境用）

### 開発環境（テスト用）

開発環境では、Resendが提供するテスト用ドメイン（`@resend.dev`）を使用できます。
本番環境に移行する前に、独自ドメインを設定することをお勧めします。

### 本番環境用の設定

1. Resendダッシュボード → "Domains"
2. "Add Domain" をクリック
3. ドメインを入力（例: `mail.yourdomain.com`）
4. DNS設定を確認
5. DNSレコードを追加（Resendが指示するレコードを追加）

---

## ステップ4: 環境変数の設定

### 1. `.env.local` ファイルの作成

プロジェクトのルートディレクトリに `.env.local` ファイルを作成します：

```bash
# プロジェクトのルートディレクトリで実行
touch .env.local
```

### 2. 環境変数を追加

`.env.local` ファイルに以下を追加：

```env
# Resend API Key
RESEND_API_KEY=re_xxxxxxxxxxxxxxxxxxxxxxxxxxxxx

# 送信元メールアドレス
# 開発環境: Resendのテスト用アドレス
RESEND_FROM_EMAIL=noreply@resend.dev

# 本番環境: 独自ドメインのメールアドレス（後で変更）
# RESEND_FROM_EMAIL=noreply@yourdomain.com
```

**設定例:**
```env
RESEND_API_KEY=re_abc123def456ghi789jkl012mno345pqr678stu901vwx234yz
RESEND_FROM_EMAIL=noreply@resend.dev
```

### 3. ファイルの保存

ファイルを保存します。

⚠️ **重要**: `.env.local` は `.gitignore` に含まれているため、Gitにはコミットされません。これは正しい動作です。

---

## ステップ5: 動作確認

### 1. 開発サーバーの再起動

環境変数を追加した後は、開発サーバーを再起動してください：

```bash
# 開発サーバーを停止（Ctrl+C）
# 再起動
npm run dev
```

### 2. 予約をテスト

1. アプリケーションを開く: http://localhost:3000
2. テスト予約を作成
3. 登録したメールアドレスを確認
4. 予約確認メールが届いているか確認

### 3. Resendダッシュボードで確認

1. Resendダッシュボード → "Emails"
2. 送信されたメールの一覧を確認
3. 送信状態を確認（成功/失敗）

---

## ステップ6: エラーの確認方法

### 1. コンソールログの確認

開発サーバーのコンソールでエラーメッセージを確認：

```
RESEND_API_KEY is not set. Skipping email sending.
```

このメッセージが表示される場合：
- `.env.local` ファイルが存在しない
- 環境変数名が間違っている
- 開発サーバーが再起動されていない

### 2. Resendダッシュボードで確認

- "Emails" セクションで送信履歴を確認
- "Logs" セクションでエラーログを確認

### 3. よくあるエラー

#### エラー1: `RESEND_API_KEY is not set`

**原因**: 環境変数が設定されていない

**解決方法**:
1. `.env.local` ファイルが存在するか確認
2. 環境変数名が正しいか確認（`RESEND_API_KEY`）
3. 開発サーバーを再起動

#### エラー2: `Unauthorized`

**原因**: APIキーが無効

**解決方法**:
1. ResendダッシュボードでAPIキーを確認
2. APIキーを再生成
3. `.env.local` を更新
4. 開発サーバーを再起動

#### エラー3: `Invalid from address`

**原因**: 送信元メールアドレスが無効

**解決方法**:
1. `RESEND_FROM_EMAIL` の形式を確認
2. ドメインが設定されているか確認（本番環境）

---

## ステップ7: 本番環境へのデプロイ

### Vercelの場合

1. Vercelダッシュボード → プロジェクト設定
2. "Environment Variables" をクリック
3. 以下の環境変数を追加：

```
RESEND_API_KEY = re_xxxxxxxxxxxxxxxxxxxxxxxxxxxxx
RESEND_FROM_EMAIL = noreply@yourdomain.com
```

4. 環境を選択（Production, Preview, Development）
5. "Save" をクリック
6. 再デプロイ

### その他のホスティングサービス

各サービスの環境変数設定方法に従って設定してください。

---

## 現在のメール送信機能

### 送信されるメール

- **予約確認メール**: 予約完了時に自動送信

### メールの内容

- 予約番号
- ご予約者様情報
- プラン情報
- 貸出・返却日時
- ご予約内容（自転車・オプション）
- 料金内訳
- ご来店についての案内

### メールテンプレート

- **HTML形式**: 見やすいデザインのメール
- **テキスト形式**: シンプルなテキストメール（HTML非対応のメールクライアント用）

---

## 今後の拡張案

### 追加できるメール機能

1. **キャンセル確認メール**
   - 予約キャンセル時に送信

2. **リマインダーメール**
   - 利用日の前日に送信

3. **返却リマインダー**
   - 返却日の前に送信

4. **管理者向け通知メール**
   - 新規予約時に管理者に通知

5. **返金確認メール**
   - 返金処理完了時に送信（決済システム導入後）

---

## 参考リンク

- [Resend公式サイト](https://resend.com)
- [Resendドキュメント](https://resend.com/docs)
- [Resend Node.js SDK](https://resend.com/docs/send-with-nodejs)
- [Next.js環境変数](https://nextjs.org/docs/basic-features/environment-variables)

---

## トラブルシューティング

### メールが届かない場合

1. **迷惑メールフォルダーを確認**
   - 開発環境では `@resend.dev` からのメールは迷惑メールになることがあります

2. **メールアドレスの確認**
   - 正しいメールアドレスを入力しているか確認

3. **Resendダッシュボードで確認**
   - メールが送信されているか確認
   - エラーがないか確認

4. **APIキーの確認**
   - APIキーが有効か確認
   - 使用量の制限に達していないか確認

### メールの形式が崩れている場合

- HTMLメールの表示に問題がある場合、テキストメールが自動的に使用されます
- メールクライアントによって表示が異なる場合があります

---

## セキュリティに関する注意事項

⚠️ **重要**:

1. **APIキーを公開しない**
   - `.env.local` はGitにコミットしない（既に `.gitignore` に含まれています）
   - 本番環境のAPIキーは環境変数で管理

2. **APIキーの権限**
   - 必要最小限の権限を付与
   - 本番環境と開発環境で別のAPIキーを使用

3. **送信元メールアドレス**
   - SPF/DKIM設定を適切に行う
   - 独自ドメインを使用することを推奨

---

## まとめ

メール送信機能の設定は以下の手順で完了します：

1. ✅ Resendアカウントの作成
2. ✅ APIキーの取得
3. ✅ `.env.local` ファイルの作成
4. ✅ 環境変数の設定
5. ✅ 動作確認
6. ✅ 本番環境への設定

設定が完了したら、予約機能を使ってメール送信をテストしてください！

